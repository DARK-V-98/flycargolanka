
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if a user has a specific role
    function isRole(role) {
      // Must check for auth being non-null before accessing it.
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    function isAdmin() {
      return isRole('admin');
    }
    
    function isDeveloper() {
      return isRole('developer');
    }

    // Users collection
    match /users/{userId} {
      // Anyone can create a user document (on signup)
      allow create: if request.auth != null;
      // Only the user themselves or an admin/dev can read/update their own profile
      allow read, update: if request.auth != null && (request.auth.uid == userId || isAdmin() || isDeveloper());
      // No one can delete user profiles through the client
      allow delete: if false;
    }

    // Bookings collection
    match /bookings/{bookingId} {
      // Logged in users can create their own bookings
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      // Users can read their own bookings. Admins/devs can read all bookings.
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin() || isDeveloper());
      // Users can cancel their own bookings (update status). Admins/devs can update any booking.
      allow update: if request.auth != null && ((resource.data.userId == request.auth.uid && request.resource.data.status == 'Cancelled') || isAdmin() || isDeveloper());
       // No one can delete bookings
      allow delete: if false;
    }

    // Shipping Rates collection
    match /shipping_rates/{countryId} {
      // Anyone can read shipping rates
      allow read: if true;
      // Only admins/devs can write rates
      allow create, update, delete: if request.auth != null && (isAdmin() || isDeveloper());
      
      // Weights subcollection
      match /weights/{weightId} {
        // Anyone can read weights
        allow read: if true;
        // Only admins/devs can write weights
        allow create, update, delete: if request.auth != null && (isAdmin() || isDeveloper());
      }
    }
    
    // Notifications collection (for admins)
    match /notifications/{notificationId} {
        // Admins can read notifications
        allow read: if request.auth != null && (isAdmin() || isDeveloper());
        // User actions or server processes can create notifications
        allow create: if true; 
        // Admins can update (e.g., mark as read)
        allow update: if request.auth != null && (isAdmin() || isDeveloper());
        // Only admins/devs can delete
        allow delete: if request.auth != null && (isAdmin() || isDeveloper());
    }

    // Settings collection (for homepage image URL)
    match /settings/{settingId} {
        // Anyone can read settings (like the homepage image URL)
        allow read: if true;
        // Only admins/devs can write settings
        allow create, update: if request.auth != null && (isAdmin() || isDeveloper());
    }
  }
}
