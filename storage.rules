rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // Rules for NIC verification images.
    // Path: /nic_verification/{userId}/{fileName}
    match /nic_verification/{userId}/{fileName} {
      // Allow authenticated users to upload their own NIC images.
      // File must be an image and under 5MB.
      allow create: if request.auth != null && request.auth.uid == userId
                    && request.resource.size < 5 * 1024 * 1024
                    && request.resource.contentType.matches('image/.*');

      // Allow the user to read their own images.
      // Allow admins and developers to read for verification purposes.
      allow read: if request.auth != null &&
                   (request.auth.uid == userId ||
                    get(/databases/(default)/documents/users/$(request.auth.uid)).data.role in ['admin', 'developer']);

      // Allow users to delete their own images (e.g., for re-submission).
      // Admins and developers can also delete.
      allow delete: if request.auth != null &&
                   (request.auth.uid == userId ||
                    get(/databases/(default)/documents/users/$(request.auth.uid)).data.role in ['admin', 'developer']);
      
      // Do not allow updating files to prevent tampering. Users should delete and re-upload.
      allow update: if false;
    }

    // Rules for the homepage promotional image.
    // Path: /homepage/{fileName}
    match /homepage/{fileName} {
      // Anyone can read the homepage image.
      allow read: if true;

      // Only admins or developers can upload, update, or delete the homepage image.
      allow write: if request.auth != null &&
                    get(/databases/(default)/documents/users/$(request.auth.uid)).data.role in ['admin', 'developer'];
    }
  }
}
